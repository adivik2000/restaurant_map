<div id="map_container">
  <div id="map" style="margin: auto; width: 960px; height: 400px;"></div>
</div>
<%= raw @map.to_html %>

<script>
  $.getJSON("/restaurants.json", function(data) {
    var restaurants = data;
    markers = new OpenLayers.Layer.Markers("Restaurants");

    for(var i = 0; i < restaurants.length; i++) {
      var restaurant = restaurants[i];
      var loc = new OpenLayers.LonLat(restaurant.longitude, restaurant.latitude);
      var marker = new OpenLayers.Marker(loc);
      marker.icon.url = '/images/OpenLayers/marker-small.png';
      marker.icon.size = {w: 12, h: 12};
      marker.restaurant = restaurant;
      markers.addMarker(marker);

      marker.events.register("mouseover", marker, function(evt) {
        var size = new OpenLayers.Size(170,30);
        var loc = new OpenLayers.LonLat(this.restaurant.longitude, this.restaurant.latitude);

        var popup = new OpenLayers.Popup.FramedCloud("rm_" + this.restaurant.id, loc, size, this.restaurant.name, this.icon, true);
        popup.positionBlocks = {
          tl: {offset: new OpenLayers.Pixel(60, -7), padding: 0, blocks: [{size: 20}]},
          tr: {offset: new OpenLayers.Pixel(-60, -7), padding: 0, blocks: []},
          bl: {offset: new OpenLayers.Pixel(60, 12), padding: 0, blocks: []},
          br: {offset: new OpenLayers.Pixel(-60, 12), padding: 0, blocks: []}
        }

        $(this.icon.imageDiv).children().attr('src', '/images/OpenLayers/marker-small-blue.png');

        popup.updateBlocks = function() {
          $(this.div).addClass("pos_" + this.relativePosition);
        }
        markers.map.addPopup(popup, true);

      });
      marker.events.register("mouseleave", marker, function(evt) {
        $(this.icon.imageDiv).children().attr('src', '/images/OpenLayers/marker-small.png');
      });
    }
    map.addLayer(markers);
  });

</script>

<div id="restaurants">
  <%= render :partial => 'restaurant', :collection => @restaurants -%>
</div>

<br />

<%= link_to 'New restaurant', new_restaurant_path %>

